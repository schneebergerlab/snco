import os
from scipy.io import mmread
import pysam

from .utils import read_cb_whitelist
from .records import MarkerRecords


def read_chrom_sizes(chrom_sizes_fn):
    chrom_sizes = {}
    with open(chrom_sizes_fn) as f:
        for record in f:
            chrom, cs = record.strip().split('\t')[:2]
            chrom_sizes[chrom] = int(cs)
    return chrom_sizes


def read_vcf(vcf_fn, bin_size):
    with pysam.VariantFile(vcf_fn) as vcf:
        variants = []
        for snp in vcf.fetch():
            variants.append((snp.contig, snp.pos // bin_size))
        return variants


def parse_cellsnp_lite(csl_dir, chrom_sizes_fn, bin_size, cb_whitelist=None):
    dep_fn = os.path.join(csl_dir, 'cellSNP.tag.DP.mtx')
    alt_fn = os.path.join(csl_dir, 'cellSNP.tag.AD.mtx')
    vcf_fn = os.path.join(csl_dir, 'cellSNP.base.vcf')
    barcode_fn = os.path.join(csl_dir, 'cellSNP.samples.tsv')

    chrom_sizes = read_chrom_sizes(chrom_sizes_fn)
    dep_mm = mmread(dep_fn)
    alt_mm = mmread(alt_fn).tocsr()
    barcodes = read_cb_whitelist(barcode_fn)
    variants = read_vcf(vcf_fn, bin_size)

    co_markers = MarkerRecords(chrom_sizes, bin_size, cb_whitelist.toset())

    for cb_idx, var_idx, tot in zip(dep_mm.col, dep_mm.row, dep_mm.data):
        cb = barcodes[cb_idx]
        if cb in cb_whitelist:
            alt = alt_mm[var_idx, cb_idx]
            ref = tot - alt
            chrom, bin_idx = variants[var_idx]
            co_markers[cb, chrom, bin_idx, 0] += ref
            co_markers[cb, chrom, bin_idx, 1] += alt
    return co_markers


def run_loadcsl(cellsnp_lite_dir, chrom_sizes_fn, output_json_fn, *,
                cb_whitelist_fn=None, bin_size=25_000):
    '''
    Read matrix files generated by cell snp lite to generate a json file of binned
    haplotype marker distributions for each cell barcode. These can be used to
    call recombinations using the downstream `predict` command.
    '''

    cb_whitelist = read_cb_whitelist(cb_whitelist_fn)
    co_markers = parse_cellsnp_lite(
        cellsnp_lite_dir,
        chrom_sizes_fn,
        bin_size=bin_size,
        cb_whitelist=cb_whitelist,
    )
    co_markers.write_json(output_json_fn)